<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Forum.TopicsLoader">
<Description>
Initial topic loader </Description>
<Super>Forum.TopicsPage</Super>
<TimeCreated>63776,59960.045951</TimeCreated>

<Method name="Load">
<Description>
Run, Main, Load</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>forum="cache"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if ##class(Forum).NameExists( forum ) {
		s sc = ##class(Forum).NameDelete( forum ) Q:'sc sc
	}
	k data s data("Name") = forum 
	s sc = ##class(Forum).Insert( .data ) Q:'sc sc
	Q ..Scan( forum )
]]></Implementation>
</Method>

<Method name="OnTopic">
<Description><![CDATA[
Event handler 
<var>data</var> - key-value array with topic properties 
If handler return 0, parsing will be interrupted]]></Description>
<FormalSpec><![CDATA[&data]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	Q:'##class(Forum).NameExists( ..Forum, .forumId ) 0
	s data("Forum") = forumId
<<<<<<< HEAD

	s topic = $g(data("ExtId")), amount = $g(data("PagesAmount"))

=======
	#;fast sql?
>>>>>>> 79844e8a43e5c294eff9d4efb5e0bf424384e916
	s sc = ##class(Topic).Insert( .data ) 
	#; any TopicsPage may have repeated first topic 
	if 'sc && ( $system.Status.GetErrorCodes( sc ) = 5808 ) {
		Q 1
	}
	Q:'sc sc
	
<<<<<<< HEAD
	s topicId = $g(data) w topicId_" "

	Q ##class(PostsLoader).Load(topic,amount)
=======
	s topicId = $g(data) w !,topicId
	/* slow OOP?
	s topic = ##class(Topic).%New() 
	s sc = topic.ForumSetObjectId( forumId ) Q:'sc sc
	
	#define g(%prop) $g(data(%prop))
	s topic.ExtId = $$$g("ExtId")
	
	s topic.Name = $$$g("Name")
	s topic.Type = $$$g("Type")
	s topic.Author = $$$g("Author")
	s topic.AuthorExtId = $g(data("Author","ExtId"))
	
	s topic.Answers = $$$g("Answers")
	s topic.Views = $$$g("Views")
	s topic.Updated = $$$g("Updated")
	s sc = topic.%Save() 
	
	#; any topics page may have repeated first topic 
	if 'sc && ( $system.Status.GetErrorCodes( sc ) = 5808 ) {
		Q 1
	}
	s sc = ##class(PostsLoader).Load($$$g("ExtId"),$$$g("PagesAmount"))
	*/
	Q sc
>>>>>>> 79844e8a43e5c294eff9d4efb5e0bf424384e916
]]></Implementation>
</Method>

<Method name="Scan">
<Description>
Example scan across all forum topic pages</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>forum="cache"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	s i = 0, count = 1, sc = 1
	for {
		
		s i = i + 1  if i > count Quit
		s page = ..GetPage( forum, i, .sc ) Q:'sc
		s:i=1 count = page.Pages() ; get pages count once
		s sc = page.Parse() Q:'sc
		w !, "Page #"_i_" successfuly loaded", !
		
	}
	Q sc
]]></Implementation>
</Method>
</Class>
</Export>
