<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Forum.PostsUpdater">
<Description>
Initial post updater</Description>
<Super>Forum.PostsPage</Super>
<TimeCreated>63785,86397.663962</TimeCreated>

<Method name="Update">
<ClassMethod>1</ClassMethod>
<FormalSpec>topic:%Integer,amountInfo:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	Q ..Scan( topic, amountInfo)
]]></Implementation>
</Method>

<Method name="Scan">
<ClassMethod>1</ClassMethod>
<FormalSpec>topic:%Integer,amountInfo:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;#amountInfo = pagesAmount_"delimeter"_oldPostsAmount_"delimeter"_postsAmount

	s lastPageNum = $p(amountInfo,"delimeter") ; it's or "a"(if we can load all pages), or number of last page of topics
	s oldPostsAmount = $p(amountInfo,"delimeter",2)
	s postsAmount = $p(amountInfo,"delimeter",3)
	
	if +lastPageNum = 0 { ;lastPageNum = "a"
		s page = ..GetPage( topic, lastPageNum, .sc ) Q:'sc
		s sc = page.Parse( oldPostsAmount) Q:'sc sc
		}
		
	else{
		
		s startPage = (oldPostsAmount\25) + 1
		s oldPostsOnStartPage = oldPostsAmount#25
		
		if lastPageNum = startPage {
			
			s page = ..GetPage( topic, startPage, .sc ) Q:'sc
			s sc = page.Parse( oldPostsOnStartPage) Q:'sc sc
			
			}
		else{
			
			s page = ..GetPage( topic, startPage, .sc ) Q:'sc
			s sc = page.Parse( oldPostsOnStartPage) Q:'sc sc
			
			for pageNum = startPage:1:lastPageNum {
				s page = ..GetPage( topic, pageNum, .sc ) Q:'sc
				s sc = page.Parse(0) Q:'sc
				}

			}			
		
		}
	Q sc
]]></Implementation>
</Method>

<Method name="Parse">
<Description>
Move from topic table begin to the end of table</Description>
<FormalSpec>oldPostsAmount:%Integer</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	s html = ..Html 
	d html.Rewind()
	s ..pos=0
	
	s pos = html.FindAt( 1, ..#PostTableBegin ) 
    if pos = -1 {
	    s sc = $$$ERROR(,"Not found begin of post's table") Q 0
    }
    s pos = pos + $l(..#PostTableBegin)
    
    s end = html.FindAt( pos, ..#PostTableEnd ) 
    if end = -1 {
	    s sc = $$$ERROR(,"Not found end of post's table") Q 0
    }
	
	s sc = html.MoveTo( pos ) Q:'sc ""
	
	s num = 0
	for {
		s num = num + 1
		s pos = html.FindAt( pos, ..#PostBegin ) Q:pos=-1
		if num'>oldPostsAmount{
			s pos = pos + $l(..#PostBegin) ;offset
			Continue
			}
		s sc = ..postBegin( pos ) Q:'sc
		s pos = pos + $l(..#PostBegin) ;offset
		}
	if sc && ( ..pos < end) {
		s sc = ..postBegin( end ) ;for last topic	
	}
]]></Implementation>
</Method>
</Class>
</Export>
